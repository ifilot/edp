image: generic-package-build-debian:v1

stages:
  - build
  - package
  - deploy

build-debian:
  stage: build
  tags:
    - debian-build
  before_script:
    - apt update && apt -y install build-essential libboost-all-dev cmake libtclap-dev pkg-config libcairo2-dev libglm-dev
  script:
    - mkdir build
    - cd build
    - cmake ../src
    - make -j3
  artifacts:
    when: on_success
    paths:
      - build/edp
    expire_in: 2 hours

package_debian:
  stage: package
  dependencies:
    - build-debian
  tags:
    - debian-build
  before_script:
    - apt update && apt -y install build-essential libboost-all-dev cmake libtclap-dev pkg-config libcairo2-dev libglm-dev binutils
  script:
    - bash build_deb.sh
  artifacts:
    when: on_success
    paths:
      - "edp*.deb"
    expire_in: 2 hours

repository_tue:
    stage: deploy
    dependencies:
      - package_debian
    variables:
      SSH_PRIVATE_KEY: "$SSH_PRIVATE_KEY"
    tags:
      - debian-build
    before_script:
      - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
      - eval $(ssh-agent -s)
      - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
      - mkdir -p ~/.ssh
      - chmod 700 ~/.ssh
      - ssh-keyscan -H st-a1960.chem.tue.nl >> ~/.ssh/known_hosts
    script:
      - scp edp*.deb ivo@st-a1960.chem.tue.nl:/home/ivo/mydebs
